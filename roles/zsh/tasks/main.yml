---
# yamllint disable rule:line-length
- name: Install zsh dependencies
  ansible.builtin.apt:
    state: present
    update_cache: true
    pkg:
      - curl
      - git
      - zsh
  become: true

- name: Write .zshrc based on template
  ansible.builtin.template:
    src: zshrc.j2
    dest: '{{ ansible_user_dir }}/.zshrc'
    backup: true
    mode: '0644'
  vars:
    oh_my_zsh:
      theme: bira
      plugins:
        - aliases
        - colored-man-pages
        - common-aliases
        - copybuffer
        - copyfile
        - extract
        - fzf
        - fzf-tab
        - gh
        - git
        - rsync
        - zsh-autosuggestions
        - zsh-syntax-highlighting

- name: Clone oh-my-zsh
  ansible.builtin.git:
    repo: https://github.com/robbyrussell/oh-my-zsh.git
    dest: '{{ oh_my_zsh_dir }}'  # noqa 401

- name: Clone zsh-autosuggestions plugin to oh-my-zsh directory
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-autosuggestions.git
    version: 'v0.7.0'
    dest: '{{ oh_my_zsh_dir }}/custom/plugins/zsh-autosuggestions'
    depth: 1

- name: Clone zsh-syntax-highlighting plugin oh-my-zsh directory
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
    version: '0.7.1'
    dest: '{{ oh_my_zsh_dir }}/custom/plugins/zsh-syntax-highlighting'
    depth: 1

- name: Clone fzf-tab plugin oh-my-zsh directory
  ansible.builtin.git:
    repo: https://github.com/Aloxaf/fzf-tab.git
    dest: '{{ oh_my_zsh_dir }}/custom/plugins/fzf-tab'
    depth: 1

- name: Clone fzf
  ansible.builtin.git:
    repo: https://github.com/junegunn/fzf.git
    dest: '{{ fzf_dir }}'
    depth: 1  # noqa 401

- name: Check fzf is installed
  ansible.builtin.stat:
    path: '{{ ansible_user_dir }}/.config/fzf'
  register: fzf_installed

- name: Install fzf
  ansible.builtin.command: "./install --all --xdg"
  args:
    chdir: "{{ fzf_dir }}"
  when: not fzf_installed.stat.exists

- name: Copy profile_block
  ansible.builtin.copy:
    src: profile_block
    dest: '/tmp/profile_block'
    mode: '0644'

- name: Reading profile_block file and register it into profile_block variable
  ansible.builtin.command: cat /tmp/profile_block
  register: profile_block
  changed_when: false

- name: Write block in file to .profile
  ansible.builtin.blockinfile:
    path: '{{ ansible_user_dir }}/.profile'
    marker: "# {mark} ANSIBLE MANAGED BLOCK profile_zsh_block sourcing"
    block: |
      {{ profile_block.stdout }}

- name: Create symbolic link .zprofile
  ansible.builtin.file:
    src: '{{ ansible_user_dir }}/.profile'
    dest: '{{ ansible_user_dir }}/.zprofile'
    state: link

- name: Set default shell for users
  ansible.builtin.user:
    name: '{{ ansible_user_id }}'
    shell: /bin/zsh
  become: true

- name: Clean up old installation paths
  ansible.legacy.include_tasks: "delete_dir.yml"
  with_items:
    - '{{ ansible_user_dir }}/.fzf'
    - '{{ ansible_user_dir }}/.oh-my-zsh'
    - '{{ ansible_user_dir }}/.config/zsh'
    - '{{ ansible_user_dir }}/.local/share/zsh'
